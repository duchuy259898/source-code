/*
 * MedicalRecordAnalysisPanel.java
 *
 * Created on 2013/04/26, 10:39
 */
package com.geobeck.sosia.pos.hair.report;

import com.geobeck.sosia.pos.hair.report.beans.SalesDateBean;
import java.awt.*;
import java.text.SimpleDateFormat;
import java.util.*;
import java.util.logging.*;
import javax.swing.*;
import javax.swing.text.*;
import org.apache.commons.lang.math.NumberUtils;

import com.geobeck.sosia.pos.system.SystemInfo;
import com.geobeck.sosia.pos.report.bean.*;
import com.geobeck.sosia.pos.hair.report.logic.MedicalRecordAnalysisLogic;
import com.geobeck.sosia.pos.hair.report.logic.TechnicSalesReportLogic;
import com.geobeck.swing.*;
import com.geobeck.sosia.pos.master.company.*;
import com.geobeck.sosia.pos.util.*;

/**
 *
 * @author katagiri
 */
public class MedicalRecordAnalysisPanel extends com.geobeck.sosia.pos.swing.AbstractImagePanelEx {

    private MstStaffs staffs = null;
    private boolean isLoading = false;
    private MedicalRecordAnalysisLogic mral = new MedicalRecordAnalysisLogic();

    /**
     * Creates new form BusinessReportPanel
     */
    public MedicalRecordAnalysisPanel() {
        isLoading = true;

        initComponents();
        addMouseCursorChange();
        this.setSize(518, 282);
        this.setPath("分析");
        this.setTitle("来店カルテ分析");
        this.setKeyListener();
        SystemInfo.initGroupShopComponents(target, 3);
        staff.addItem(new MstStaff());
        SystemInfo.initStaffComponent(staff);
        staff.setSelectedIndex(0);
        Calendar cal = Calendar.getInstance();
        int nowYear = cal.get(Calendar.YEAR);
        initYearCombo(cmbYear, nowYear);
        changeTargetDate();
        isLoading = false;
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        countTypeGroup = new javax.swing.ButtonGroup();
        techClassTypeGroup = new javax.swing.ButtonGroup();
        jPanel1 = new javax.swing.JPanel();
        lblTargetPeriod3 = new javax.swing.JLabel();
        lblTargetDate = new javax.swing.JLabel();
        jLabel5 = new javax.swing.JLabel();
        staff = new com.geobeck.sosia.pos.swing.JComboBoxLabel();
        lblTargetPeriod1 = new javax.swing.JLabel();
        cmbYear = new javax.swing.JComboBox();
        lblTargetPeriod2 = new javax.swing.JLabel();
        btnOutputExcel = new javax.swing.JButton();
        targetLabel = new javax.swing.JLabel();
        target = new com.geobeck.sosia.pos.swing.JComboBoxLabel();

        setFocusCycleRoot(true);

        jPanel1.setOpaque(false);

        lblTargetPeriod3.setText("評価期間");

        jLabel5.setText("担当者");

        staff.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(204, 204, 204)));

        lblTargetPeriod1.setText("集計年度");

        cmbYear.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(0, 0, 0)));
        cmbYear.addItemListener(new java.awt.event.ItemListener() {
            public void itemStateChanged(java.awt.event.ItemEvent evt) {
                cmbYearStateChanged(evt);
            }
        });

        lblTargetPeriod2.setText("年");

        org.jdesktop.layout.GroupLayout jPanel1Layout = new org.jdesktop.layout.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
            .add(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .add(jPanel1Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING, false)
                    .add(jLabel5, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 80, Short.MAX_VALUE)
                    .add(jPanel1Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING, false)
                        .add(lblTargetPeriod1, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .add(lblTargetPeriod3, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 80, Short.MAX_VALUE)))
                .add(jPanel1Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
                    .add(jPanel1Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
                        .add(jPanel1Layout.createSequentialGroup()
                            .add(18, 18, 18)
                            .add(lblTargetDate, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 323, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                            .addContainerGap(org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                        .add(org.jdesktop.layout.GroupLayout.TRAILING, jPanel1Layout.createSequentialGroup()
                            .add(18, 18, 18)
                            .add(cmbYear, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 59, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                            .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                            .add(lblTargetPeriod2)
                            .add(334, 334, 334)))
                    .add(org.jdesktop.layout.GroupLayout.TRAILING, jPanel1Layout.createSequentialGroup()
                        .add(18, 18, 18)
                        .add(staff, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 138, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                        .add(270, 270, 270))))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
            .add(jPanel1Layout.createSequentialGroup()
                .add(jPanel1Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
                    .add(jLabel5)
                    .add(staff, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
                .add(3, 3, 3)
                .add(jPanel1Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
                    .add(lblTargetPeriod1)
                    .add(cmbYear, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 24, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                    .add(lblTargetPeriod2))
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(jPanel1Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
                    .add(lblTargetPeriod3, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 21, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                    .add(lblTargetDate, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 21, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(171, Short.MAX_VALUE))
        );

        btnOutputExcel.setIcon(SystemInfo.getImageIcon("/button/print/excel_off.jpg"));
        btnOutputExcel.setBorderPainted(false);
        btnOutputExcel.setContentAreaFilled(false);
        btnOutputExcel.setFocusCycleRoot(true);
        btnOutputExcel.setPressedIcon(SystemInfo.getImageIcon("/button/print/excel_on.jpg"));
        btnOutputExcel.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnOutputExcelActionPerformed(evt);
            }
        });

        targetLabel.setText("店舗");

        target.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                targetActionPerformed(evt);
            }
        });

        org.jdesktop.layout.GroupLayout layout = new org.jdesktop.layout.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
            .add(layout.createSequentialGroup()
                .addContainerGap()
                .add(targetLabel, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .add(18, 18, 18)
                .add(target, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 142, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                .add(58, 58, 58)
                .add(btnOutputExcel, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 92, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                .add(116, 116, 116))
            .add(jPanel1, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
            .add(layout.createSequentialGroup()
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
                    .add(layout.createSequentialGroup()
                        .add(16, 16, 16)
                        .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
                            .add(targetLabel)
                            .add(target, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)))
                    .add(layout.createSequentialGroup()
                        .addContainerGap()
                        .add(btnOutputExcel, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 25, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)))
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(jPanel1, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addContainerGap())
        );
    }// </editor-fold>//GEN-END:initComponents

    private void targetActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_targetActionPerformed
        if (isLoading) {
            return;
        }
        changeTargetDate();
    }//GEN-LAST:event_targetActionPerformed

    private void btnOutputExcelActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnOutputExcelActionPerformed

        if (!SystemInfo.checkAuthorityPassword(260)) {
            return;
        }

        if (inputCheck()) {

            btnOutputExcel.setCursor(null);

            try {

                setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));
                mral.year = cmbYear.getSelectedItem().toString();
                this.doOutput();

            } finally {
                setCursor(Cursor.getPredefinedCursor(Cursor.DEFAULT_CURSOR));
            }
        }

    }//GEN-LAST:event_btnOutputExcelActionPerformed

    private void cmbYearStateChanged(java.awt.event.ItemEvent evt) {//GEN-FIRST:event_cmbYearStateChanged
        changeTargetDate();
    }//GEN-LAST:event_cmbYearStateChanged

    private void changeTargetDate() {
        // 集計期間を求める
        Calendar cal = Calendar.getInstance();
        try {

            cal.set(Calendar.YEAR, Integer.parseInt(this.cmbYear.getSelectedItem().toString()));
        } catch (Exception e) {
            MessageDialog.showMessageDialog(this,
                    MessageUtil.getMessage(MessageUtil.ERROR_INPUT_WRONG, "集計年度"),
                    this.getTitle(),
                    JOptionPane.ERROR_MESSAGE);
            cmbYear.setSelectedItem(Calendar.getInstance().get(Calendar.YEAR));
            return;
        }
        cal.set(Calendar.DAY_OF_MONTH, 1);

        java.util.Date targetDate = null;
        try {
            targetDate = cal.getTime();
        } catch (Exception e) {
        }

        if (targetDate == null) {
            MessageDialog.showMessageDialog(this,
                    MessageUtil.getMessage(MessageUtil.ERROR_INPUT_WRONG, "集計年度"),
                    this.getTitle(),
                    JOptionPane.ERROR_MESSAGE);
            cmbYear.setSelectedItem(Calendar.getInstance().get(Calendar.YEAR));
            return;
        }

        // ○ヶ月前の月初
//	Calendar calculationStart = Calendar.getInstance();
//	calculationStart.setTime(targetDate);
        // 再来対象期間
        // 開始日は集計開始日と同じ
        Calendar targetStart = Calendar.getInstance();
        //targetStart.setTime(calculationStart.getTime());
        targetStart.set(Integer.parseInt(this.cmbYear.getSelectedItem().toString()), 0, 1);
        //targetStart.set(Calendar.DAY_OF_MONTH, 1);

        Calendar targetEnd = Calendar.getInstance();
        //targetEnd.setTime(targetStart.getTime());
        targetEnd.set(Integer.parseInt(this.cmbYear.getSelectedItem().toString()), 11, 31);
        //targetEnd.set(Calendar.DAY_OF_MONTH, 31);
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy/MM/dd");
        this.lblTargetDate.setText(sdf.format(targetStart.getTime()) + " 〜 " + sdf.format(targetEnd.getTime()));
    }

    /**
     * 再来算出期間を求める
     */
    private void doOutput() {

        SimpleDateFormat sdf = new SimpleDateFormat("yyyy/MM/dd");

        MedicalRecordAnalysisLogic logic = new MedicalRecordAnalysisLogic();
        ReportParameterBean paramBean = new ReportParameterBean();
        paramBean.setMainReportType(ReportParameterBean.MAIN_REPORT_STAFF);

        //グループ
        if (target.getSelectedItem() instanceof MstGroup) {
            MstGroup mg = (MstGroup) target.getSelectedItem();
            paramBean.setTargetName(mg.getGroupName());
            paramBean.setShopIDList(mg.getShopIDListAll());
        } //店舗
        else if (target.getSelectedItem() instanceof MstShop) {
            MstShop ms = (MstShop) target.getSelectedItem();
            paramBean.setTargetName(ms.getShopName());
            paramBean.setShopIDList(ms.getShopID().toString());
        }

        //対象となる店舗が存在しない場合
        if (paramBean.getShopIDList().equals("")) {
            MessageDialog.showMessageDialog(this,
                    MessageUtil.getMessage(4001),
                    this.getTitle(),
                    JOptionPane.ERROR_MESSAGE);
            return;
        }

        // 主担当者
        if (staff.getSelectedIndex() > 0) {
            paramBean.setStaffId(((MstStaff) staff.getSelectedItem()).getStaffID());
            paramBean.setStaffName(((MstStaff) staff.getSelectedItem()).getFullStaffName());
        } else {
            paramBean.setStaffId(null);
            paramBean.setStaffName("全体");
        }
        // 集計期間を求める
        Calendar cal = Calendar.getInstance();
        try {
            cal.set(Calendar.YEAR, Integer.parseInt(this.cmbYear.getSelectedItem().toString()));
        } catch (Exception e) {
        }
        cal.set(Calendar.DAY_OF_MONTH, 1);



        // 選んだ月の月末
        Calendar calculationEnd = Calendar.getInstance();
        calculationEnd.set(Integer.parseInt(this.cmbYear.getSelectedItem().toString()), 1, 1);// 選択月の翌月にして
        calculationEnd.add(Calendar.DAY_OF_MONTH, -1); // １日戻す



        //出力処理
        boolean logicResult = true;
        try {
            Calendar calStart = Calendar.getInstance();
            calStart.set(Integer.parseInt(this.cmbYear.getSelectedItem().toString()), 0, 1);
            paramBean.setTargetStartDateObj(calStart.getTime());
            Calendar calEnd = (Calendar) calStart.clone();
            calEnd.set(Integer.parseInt(this.cmbYear.getSelectedItem().toString()), 11, 31);
            paramBean.setTargetEndDateObj(calEnd.getTime());
            logicResult = logic.MedicalRecordAnalysis(paramBean);


        } catch (Exception e) {

            SystemInfo.getLogger().log(Level.SEVERE, e.getLocalizedMessage(), e);
            MessageDialog.showMessageDialog(
                    this,
                    MessageUtil.getMessage(1099),
                    this.getTitle(),
                    JOptionPane.ERROR_MESSAGE);

            return;
        }

        // エラー時
        if (!logicResult) {
            MessageDialog.showMessageDialog(
                    this,
                    MessageUtil.getMessage(4001),
                    this.getTitle(),
                    JOptionPane.ERROR_MESSAGE);
        }
    }
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnOutputExcel;
    private javax.swing.JComboBox cmbYear;
    private javax.swing.ButtonGroup countTypeGroup;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JLabel lblTargetDate;
    private javax.swing.JLabel lblTargetPeriod1;
    private javax.swing.JLabel lblTargetPeriod2;
    private javax.swing.JLabel lblTargetPeriod3;
    private com.geobeck.sosia.pos.swing.JComboBoxLabel staff;
    private com.geobeck.sosia.pos.swing.JComboBoxLabel target;
    private javax.swing.JLabel targetLabel;
    private javax.swing.ButtonGroup techClassTypeGroup;
    // End of variables declaration//GEN-END:variables
    private BusinessReportFocusTraversalPolicy ftp =
            new BusinessReportFocusTraversalPolicy();

    /**
     * ボタンにマウスカーソルが乗ったときにカーソルを変更するイベントを追加する。
     */
    private void addMouseCursorChange() {
        SystemInfo.addMouseCursorChange(btnOutputExcel);
    }

    private void setKeyListener() {
        cmbYear.addKeyListener(SystemInfo.getMoveNextField());
        staff.addKeyListener(SystemInfo.getMoveNextField());
    }

//	private void initCmbYear() {
//        this.cmbYear.removeAllItems();
//        int index = -1;
//        MstShop shopinfo;
//        
//        shopinfo = (MstShop)this.target.getSelectedItem();
//        ArrayList<SalesDateBean> beanlist = TechnicSalesReportLogic.getSalesDateBean(shopinfo.getShopID());
//        Calendar calendar = Calendar.getInstance();
//        String currentYear = new String(calendar.get(Calendar.YEAR)+"");
//        for(int i= 0; i < beanlist.size() ; i++ ) {
//            this.cmbYear.addItem(beanlist.get(i).getYear());
//            if( beanlist.get(i).getYear().equals(currentYear)){
//                index = i;
//                }
//             }
//        }
    

    private Integer getSelectedYear() {
        String year = (String) this.cmbYear.getSelectedItem();

        return Integer.valueOf(year.replaceAll("年", ""));
    }

    /**
     * 業務報告画面用FocusTraversalPolicyを取得する。
     *
     * @return 業務報告画面用FocusTraversalPolicy
     */
    public BusinessReportFocusTraversalPolicy getFocusTraversalPolicy() {
        return ftp;
    }

    /**
     * 業務報告画面用FocusTraversalPolicy
     */
    private class BusinessReportFocusTraversalPolicy
            extends FocusTraversalPolicy {

        /**
         * aComponBusinessReportFocusTraversalPolicy。 aContainer は aComponent
         * のフォーカスサイクルのルートまたはフォーカストラバーサルポリシープロバイダでなければなりません。
         *
         * @param aContainer aComponent のフォーカスサイクルのルートまたはフォーカストラバーサルポリシープロバイダ
         * @param aComponent aContainer のおそらく間接的な子、または aContainer 自体
         * @return aComponent のあとにフォーカスを受け取る Component。適切な Component が見つからない場合は
         * null
         */
        public Component getComponentAfter(Container aContainer,
                Component aComponent) {
            if(aComponent.equals(target))
            {
                return staff;
            }
            else if(aComponent.equals(staff))
            {
                return cmbYear;
            }
            return this.getStartComponent();
        }
        private Component getStartComponent() 
        {
            if(target.getItemCount() == 1){
                return staff ;
            }
            else {
                return target;
            }
        }

        /**
         * aComponent の前にフォーカスを受け取る Component を返します。 aContainer は aComponent
         * のフォーカスサイクルのルートまたはフォーカストラバーサルポリシープロバイダでなければなりません。
         *
         * @param aContainer aComponent のフォーカスサイクルのルートまたはフォーカストラバーサルポリシープロバイダ
         * @param aComponent aContainer のおそらく間接的な子、または aContainer 自体
         * @return aComponent の前にフォーカスを受け取る Component。適切な Component が見つからない場合は
         * null
         */
        public Component getComponentBefore(Container aContainer,
                Component aComponent) {
           if(aComponent.equals(target))
            {
                return target;
            }
           else if(aComponent.equals(staff))
            {
                return this.getStartComponent();
            }
           else if(aComponent.equals(cmbYear))
            {
                return staff;
            }
            return this.getStartComponent();
        }

        /**
         * トラバーサルサイクルの最初の Component を返します。 このメソッドは、順方向のトラバーサルがラップするときに、次にフォーカスする
         * Component を判定するために使用します。
         *
         * @param aContainer 先頭の Component
         * を返すフォーカスサイクルのルートまたはフォーカストラバーサルポリシープロバイダ
         * @return aContainer のトラバーサルサイクルの先頭の Componet、または適切な Component
         * が見つからない場合は null
         */
        public Component getFirstComponent(Container aContainer) {
            return this.getStartComponent();
        }

        /**
         * フォーカスを設定するデフォルトコンポーネントを返します。 aContainer
         * をルートとするフォーカストラバーサルサイクルが新しく開始されたときに、このコンポーネントに最初にフォーカスが設定されます。
         *
         * @param aContainer デフォルトの Component
         * を返すフォーカスサイクルのルートまたはフォーカストラバーサルポリシープロバイダ
         * @return aContainer のトラバーサルサイクルのデフォルトの Componet、または適切な Component
         * が見つからない場合は null
         */
        public Component getDefaultComponent(Container aContainer) {
            return this.getStartComponent();
        }

        /**
         * ウィンドウが最初に表示されたときにフォーカスが設定されるコンポーネントを返します。 show() または setVisible(true)
         * の呼び出しで一度ウィンドウが表示されると、 初期化コンポーネントはそれ以降使用されません。
         * 一度別のウィンドウに移ったフォーカスが再び設定された場合、 または、一度非表示状態になったウィンドウが再び表示された場合は、
         * そのウィンドウの最後にフォーカスが設定されたコンポーネントがフォーカス所有者になります。
         * このメソッドのデフォルト実装ではデフォルトコンポーネントを返します。
         *
         * @param window 初期コンポーネントが返されるウィンドウ
         * @return 最初にウィンドウが表示されるときにフォーカス設定されるコンポーネント。適切なコンポーネントがない場合は null
         */
        public Component getInitialComponent(Window window) {
            return this.getStartComponent();
        }

        @Override
        public Component getLastComponent(Container aContainer) {
            throw new UnsupportedOperationException("Not supported yet.");
        }
    }

    private void resetSpan(Calendar calStart, Calendar calEnd) {

        int cutoffDay = 0;

        if (target.getSelectedItem() instanceof MstShop) {
            MstShop ms = (MstShop) target.getSelectedItem();
            cutoffDay = ms.getCutoffDay();
        } else {
            cutoffDay = SystemInfo.getAccountSetting().getCutoffDay();
        }

        if (cutoffDay == 31) {
            return;
        }

        Calendar calTo = Calendar.getInstance();
        calTo.setTime(calEnd.getTime());

        if (calTo.getActualMaximum(Calendar.DATE) <= cutoffDay) {
            calTo.set(Calendar.DAY_OF_MONTH, calTo.getActualMaximum(Calendar.DATE));
        } else {
            calTo.set(Calendar.DAY_OF_MONTH, cutoffDay);
        }

        Calendar calFrom = (Calendar) calTo.clone();
        calFrom.add(Calendar.MONTH, -1);
        calFrom.add(Calendar.DAY_OF_MONTH, 1);

        calStart.setTime(calFrom.getTime());
        calEnd.setTime(calTo.getTime());
    }

    private void initYearCombo(final JComboBox cmb, int nowYear) {

        cmb.removeAllItems();

        int y = Calendar.getInstance().get(Calendar.YEAR);
        for (int i = 0; i < 5; i++) {
            cmb.addItem(String.valueOf(y - i));
        }
        cmb.setSelectedItem(nowYear);
        cmb.getEditor().getEditorComponent().addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusGained(java.awt.event.FocusEvent evt) {
                ((JTextField) cmb.getEditor().getEditorComponent()).selectAll();
            }
        });
    }

    private boolean inputCheck() {
        NumberUtils numUtil = new NumberUtils();
        if (!numUtil.isNumber(this.cmbYear.getSelectedItem().toString())) {
            MessageDialog.showMessageDialog(this,
                    MessageUtil.getMessage(MessageUtil.ERROR_INPUT_EMPTY, "対象年"),
                    this.getTitle(),
                    JOptionPane.ERROR_MESSAGE);
            Calendar cdr = Calendar.getInstance();
            this.cmbYear.requestFocusInWindow();
            return false;
        }

        return true;
    }
}
