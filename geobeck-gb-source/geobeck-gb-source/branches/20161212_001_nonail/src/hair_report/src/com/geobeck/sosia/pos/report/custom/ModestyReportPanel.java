/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package com.geobeck.sosia.pos.report.custom;

import com.geobeck.sosia.pos.master.company.MstGroup;
import com.geobeck.sosia.pos.master.company.MstShop;
import com.geobeck.sosia.pos.master.company.MstStaff;
import java.util.Calendar;
import java.util.Date;

import com.geobeck.sosia.pos.system.SystemInfo;
import com.geobeck.sosia.pos.util.MessageUtil;
import com.geobeck.swing.MessageDialog;
import java.awt.Cursor;
import java.sql.SQLException;
import java.text.SimpleDateFormat;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.ButtonModel;
import javax.swing.JComboBox;
import javax.swing.JOptionPane;

/**
 *
 * @author yasumoto
 */
public class ModestyReportPanel extends com.geobeck.sosia.pos.swing.AbstractImagePanelEx {

	/**
	 * Creates new form ModestyReportPanel
	 */
	public ModestyReportPanel() {
        initComponents();
        this.setSize(958, 750);
        this.setPath("カスタム帳票");
        this.setTitle("カスタム帳票");
        this.setKeyListener();
        init();
    }

    private void setKeyListener() {

        cmbTargetDate.addKeyListener(SystemInfo.getMoveNextField());
        cmbTargetDate.addFocusListener(SystemInfo.getSelectText());
        repoCommitionButton.addKeyListener(SystemInfo.getMoveNextField());
        repoEkimuButton.addKeyListener(SystemInfo.getMoveNextField());
        repoHanbaiButton.addKeyListener(SystemInfo.getMoveNextField());
        printButton.addKeyListener(SystemInfo.getMoveNextField());
    }

    /**
     * init form
     */
    private void init() {

        Calendar cal = Calendar.getInstance();
		
        //期間を初期設定する    
        Calendar cdr = Calendar.getInstance();
        cdr.setTime(new Date());

        cal.add(Calendar.MONTH, 1);
        cal.set(Calendar.DAY_OF_MONTH, 1);
        cal.add(Calendar.YEAR, -1);
        cal.add(Calendar.YEAR, 1);
        cal.add(Calendar.DAY_OF_MONTH, -1);

        //対象期間の設定
        this.cmbTargetDate.setDate(new Date());
		this.repoHanbaiButton.doClick();
		setMonthLaelState(false);
    }

	private void setMonthLabel() {
		SimpleDateFormat sdf = new SimpleDateFormat("yyyy年MM月");
		this.lblMonth.setText("(対象月：" + sdf.format(this.cmbTargetDate.getDate())+")");
	}
	
	private void setMonthLaelState(boolean param) {
		this.lblMonth.setVisible(param);
		this.lblStaff.setVisible(param);
		this.cmbStaff.setVisible(param);
	}
	
	/**
	 * 担当者を初期化する。
	 */
	protected void initStaff( JComboBox combobox )
	{
		if (cblShop.getSelectedItem() != null
				&& cblShop.getSelectedItem() instanceof MstShop){
			MstShop shop = (MstShop) cblShop.getSelectedItem();
			combobox.removeAllItems();
			combobox.addItem(new MstStaff());
			try {
				MstStaff.addStaffDataToJComboBox(SystemInfo.getConnection(),
						combobox, shop.getShopID());
			} catch (SQLException ex) {
				SystemInfo.getLogger().log(Level.SEVERE, null, ex);
			}
		} else {
			combobox.removeAllItems();
		}
	}
	
	/**
	 * This method is called from within the constructor to initialize the form. WARNING: Do NOT modify this code. The content of this method is always
	 * regenerated by the Form Editor.
	 */
	@SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        reportGroup = new javax.swing.ButtonGroup();
        cmbTargetDate = new jp.co.flatsoft.fscomponent.FSCalenderCombo();
        repoHanbaiButton = new javax.swing.JRadioButton();
        repoEkimuButton = new javax.swing.JRadioButton();
        repoCommitionButton = new javax.swing.JRadioButton();
        lblDate = new javax.swing.JLabel();
        lblReport = new javax.swing.JLabel();
        printButton = new javax.swing.JButton();
        lblMonth = new javax.swing.JLabel();
        cblShop = new com.geobeck.sosia.pos.swing.JComboBoxLabel();
        lblShop = new javax.swing.JLabel();
        cmbStaff = new javax.swing.JComboBox();
        lblStaff = new javax.swing.JLabel();

        setPreferredSize(new java.awt.Dimension(958, 750));

        cmbTargetDate.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(204, 204, 204)));
        cmbTargetDate.setFocusCycleRoot(true);
        cmbTargetDate.addItemListener(new java.awt.event.ItemListener() {
            public void itemStateChanged(java.awt.event.ItemEvent evt) {
                cmbTargetDateItemStateChanged(evt);
            }
        });

        reportGroup.add(repoHanbaiButton);
        repoHanbaiButton.setText("販売実績表");
        repoHanbaiButton.setActionCommand("A");
        repoHanbaiButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                repoHanbaiButtonActionPerformed(evt);
            }
        });

        reportGroup.add(repoEkimuButton);
        repoEkimuButton.setText("役務償却日報");
        repoEkimuButton.setActionCommand("B");
        repoEkimuButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                repoEkimuButtonActionPerformed(evt);
            }
        });

        reportGroup.add(repoCommitionButton);
        repoCommitionButton.setText("コミッション明細書");
        repoCommitionButton.setActionCommand("C");
        repoCommitionButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                repoCommitionButtonActionPerformed(evt);
            }
        });

        lblDate.setText("対象日");

        lblReport.setText("出力帳票");

        printButton.setIcon(SystemInfo.getImageIcon("/button/print/excel_off.jpg"));
        printButton.setText("　");
        printButton.setToolTipText("Excel出力");
        printButton.setBorderPainted(false);
        printButton.setContentAreaFilled(false);
        printButton.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        printButton.setPressedIcon(SystemInfo.getImageIcon("/button/print/excel_on.jpg"));
        printButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                printButtonActionPerformed(evt);
            }
        });

        lblMonth.setText("　");

        cblShop.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(127, 157, 185)));
        cblShop.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cblShopActionPerformed(evt);
            }
        });

        lblShop.setText("対象");

        cmbStaff.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(204, 204, 204)));

        lblStaff.setText("スタッフ名");

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(25, 25, 25)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(lblReport, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(lblDate)
                    .addComponent(lblShop)
                    .addComponent(lblStaff, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addGap(28, 28, 28)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(cmbStaff, javax.swing.GroupLayout.PREFERRED_SIZE, 160, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(cblShop, javax.swing.GroupLayout.PREFERRED_SIZE, 130, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                        .addComponent(printButton, javax.swing.GroupLayout.PREFERRED_SIZE, 99, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGroup(layout.createSequentialGroup()
                            .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                .addComponent(repoHanbaiButton)
                                .addComponent(cmbTargetDate, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                            .addGap(31, 31, 31)
                            .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                                .addGroup(layout.createSequentialGroup()
                                    .addComponent(repoEkimuButton, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                                    .addGap(34, 34, 34)
                                    .addComponent(repoCommitionButton))
                                .addComponent(lblMonth, javax.swing.GroupLayout.PREFERRED_SIZE, 238, javax.swing.GroupLayout.PREFERRED_SIZE)))))
                .addContainerGap(500, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(16, 16, 16)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblShop, javax.swing.GroupLayout.PREFERRED_SIZE, 20, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(cblShop, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(cmbStaff, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(3, 3, 3)
                        .addComponent(lblStaff, javax.swing.GroupLayout.PREFERRED_SIZE, 16, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addGap(18, 18, 18)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblReport)
                    .addComponent(repoHanbaiButton)
                    .addComponent(repoEkimuButton)
                    .addComponent(repoCommitionButton))
                .addGap(18, 18, 18)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(lblMonth, javax.swing.GroupLayout.PREFERRED_SIZE, 23, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblDate, javax.swing.GroupLayout.PREFERRED_SIZE, 23, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(cmbTargetDate, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(printButton)
                .addContainerGap(578, Short.MAX_VALUE))
        );
    }// </editor-fold>//GEN-END:initComponents

    private void cmbTargetDateItemStateChanged(java.awt.event.ItemEvent evt) {//GEN-FIRST:event_cmbTargetDateItemStateChanged
		setMonthLabel();
    }//GEN-LAST:event_cmbTargetDateItemStateChanged

    private void repoCommitionButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_repoCommitionButtonActionPerformed
		setMonthLaelState(true);
		cblShop.removeAllItems();
		SystemInfo.initGroupShopComponents(cblShop, 2);
    }//GEN-LAST:event_repoCommitionButtonActionPerformed

    private void repoEkimuButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_repoEkimuButtonActionPerformed
		setMonthLaelState(false);
		cblShop.removeAllItems();
		SystemInfo.initGroupShopComponents(cblShop, 2);
    }//GEN-LAST:event_repoEkimuButtonActionPerformed

    private void repoHanbaiButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_repoHanbaiButtonActionPerformed
		setMonthLaelState(false);
		cblShop.removeAllItems();
		SystemInfo.initGroupShopComponents(cblShop, 3);
    }//GEN-LAST:event_repoHanbaiButtonActionPerformed

    private void cblShopActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cblShopActionPerformed
		initStaff(cmbStaff);
    }//GEN-LAST:event_cblShopActionPerformed

    private void printButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_printButtonActionPerformed
        printButton.setCursor(null);
		ModestyReportLogic logic = new ModestyReportLogic();
		
        try {
			boolean logicResult = true;
            setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));
			Date targetDate = this.cmbTargetDate.getDate();
			ButtonModel targetRepo = this.reportGroup.getSelection();
			
			try {
				if(targetRepo.getActionCommand().equals("C")) { 
				// コミッション明細書
					if(cblShop.getSelectedItem() instanceof MstGroup
						|| cmbStaff.getSelectedIndex()==0) {
						MessageDialog.showMessageDialog(this,
								MessageUtil.getMessage(1102, "スタッフ名"),
								this.getTitle(),
								JOptionPane.ERROR_MESSAGE);
						return;
					}
					MstShop shop = (MstShop) cblShop.getSelectedItem();
					MstStaff staff = (MstStaff)cmbStaff.getSelectedItem();
					logicResult = logic.printMonthlyCommission(shop, staff, targetDate);
					
				} else {
					MstGroup mg = null;
					MstShop ms = null;
					//グループ
					if (cblShop.getSelectedItem() instanceof MstGroup) {
						mg = (MstGroup) cblShop.getSelectedItem();
					} //店舗
					else if (cblShop.getSelectedItem() instanceof MstShop) {
						ms = (MstShop) cblShop.getSelectedItem();
					}

					if(targetRepo.getActionCommand().equals("B")) {
						// 償却日報
						logicResult = logic.printDailyReport((mg!=null)? mg: ms, targetDate);
					}
				}

            } catch (Exception e) {
                SystemInfo.getLogger().log(Level.SEVERE, e.getLocalizedMessage(), e);
                MessageDialog.showMessageDialog(this,
                        MessageUtil.getMessage(1099),
                        this.getTitle(),
                        JOptionPane.ERROR_MESSAGE);
                return;
            }
			
			if (!logicResult) {
				MessageDialog.showMessageDialog(this,
				MessageUtil.getMessage(4001),
				this.getTitle(),
				JOptionPane.ERROR_MESSAGE);
			}
		} finally {
            setCursor(Cursor.getPredefinedCursor(Cursor.DEFAULT_CURSOR));
        }
    }//GEN-LAST:event_printButtonActionPerformed


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private com.geobeck.sosia.pos.swing.JComboBoxLabel cblShop;
    protected javax.swing.JComboBox cmbStaff;
    private jp.co.flatsoft.fscomponent.FSCalenderCombo cmbTargetDate;
    private javax.swing.JLabel lblDate;
    private javax.swing.JLabel lblMonth;
    private javax.swing.JLabel lblReport;
    private javax.swing.JLabel lblShop;
    private javax.swing.JLabel lblStaff;
    private javax.swing.JButton printButton;
    private javax.swing.JRadioButton repoCommitionButton;
    private javax.swing.JRadioButton repoEkimuButton;
    private javax.swing.JRadioButton repoHanbaiButton;
    private javax.swing.ButtonGroup reportGroup;
    // End of variables declaration//GEN-END:variables
}
